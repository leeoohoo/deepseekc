import { useState, useEffect } from 'react';
import { 
  BookOpen, 
  Terminal, 
  Download, 
  Settings, 
  Command, 
  Users, 
  Wrench, 
  ListChecks, 
  Monitor,
  HelpCircle, 
  FileText,
  ChevronRight,
  Copy,
  Check,
  ExternalLink,
  Folder,
  Code,
  Cpu,
  GitBranch,
  Zap,
  Shield,
  Cloud,
  Database
} from 'lucide-react';
import { useTranslation } from 'react-i18next';
// Import UI interface SVGs
import DashboardSVG from '../assets/svg/dashboard.svg';
import FileBrowserSVG from '../assets/svg/file-browser.svg';
import FloatingIslandSVG from '../assets/svg/floating-island.svg';
import ConfigurationSVG from '../assets/svg/configuration.svg';
import { motion } from 'framer-motion';
import SEO from '../components/SEO';

const Docs = () => {
  const { t } = useTranslation();

  const [activeSection, setActiveSection] = useState('getting-started');
  const [copiedCommands, setCopiedCommands] = useState({});

  const copyToClipboard = (text, id) => {
    navigator.clipboard.writeText(text);
    setCopiedCommands({ ...copiedCommands, [id]: true });
    setTimeout(() => {
      setCopiedCommands({ ...copiedCommands, [id]: false });
    }, 2000);
  };

  const sidebarItems = [
    { id: 'getting-started', label: t('docs.sidebar.gettingStarted'), icon: <BookOpen className="w-5 h-5" /> },
    { id: 'ui-interface', label: t('docs.sidebar.uiInterface'), icon: <Monitor className="w-5 h-5" /> },
    { id: 'installation', label: t('docs.sidebar.installation'), icon: <Download className="w-5 h-5" /> },
    { id: 'configuration', label: t('docs.sidebar.configuration'), icon: <Settings className="w-5 h-5" /> },
    { id: 'commands-reference', label: t('docs.sidebar.commandsReference'), icon: <Command className="w-5 h-5" /> },
    { id: 'sub-agent-system', label: t('docs.sidebar.subAgentSystem'), icon: <Users className="w-5 h-5" /> },
    { id: 'mcp-tools', label: t('docs.sidebar.mcpTools'), icon: <Wrench className="w-5 h-5" /> },
    { id: 'task-management', label: t('docs.sidebar.taskManagement'), icon: <ListChecks className="w-5 h-5" /> },
    { id: 'troubleshooting', label: t('docs.sidebar.troubleshooting'), icon: <HelpCircle className="w-5 h-5" /> },
    { id: 'environment-variables', label: t('docs.sidebar.environmentVariables'), icon: <FileText className="w-5 h-5" /> },
  ];

  const installationCommands = [
    {
      title: t('docs.installationCommands.npmGlobalInstall.title'),
      command: 'npm install -g @leeoohoo/deepseek-cli',
      description: t('docs.installationCommands.npmGlobalInstall.description')
    },
    {
      title: t('docs.installationCommands.thenRun.title'),
      command: 'deepseekc chat',
      description: t('docs.installationCommands.thenRun.description')
    },
    {
      title: t('docs.installationCommands.alternativeNpx.title'),
      command: 'npx @leeoohoo/deepseek-cli chat',
      description: t('docs.installationCommands.alternativeNpx.description')
    },
    {
      title: t('docs.installationCommands.alternativeFromSource.title'),
      command: `git clone https://github.com/leeoohoo/deepseek-cli
cd deepseek-cli
npm install
node src/cli.js chat`,
      description: t('docs.installationCommands.alternativeFromSource.description')
    }
  ];

  const configPaths = [
    { path: '~/.deepseek_cli/auth/models.yaml', description: t('docs.configPaths.models') },
    { path: '~/.deepseek_cli/auth/system-prompt.yaml', description: t('docs.configPaths.systemPrompt') },
    { path: '.deepseek_cli/tasks.json', description: t('docs.configPaths.tasks') },
    { path: '~/.deepseek_cli/subagents.json', description: t('docs.configPaths.subagents') },
  ];

  const chatCommands = [
    { command: '/sub marketplace', description: t('docs.chatCommands.marketplace') },
    { command: '/sub install <id>', description: t('docs.chatCommands.install') },
    { command: '/sub agents', description: t('docs.chatCommands.agents') },
    { command: '/sub run <agent_id> <task> [--skills skill1,skill2]', description: t('docs.chatCommands.run') },
    { command: '/prompt', description: t('docs.chatCommands.prompt') },
    { command: '/tool [id]', description: t('docs.chatCommands.tool') },
    { command: '/reset', description: t('docs.chatCommands.reset') },
  ];

  const mcpToolsMain = [
    'invoke_sub_agent',
    'get_current_time',
    'mcp_subagent_router_*',
    'mcp_task_manager_*',
  ];

  const mcpToolsSub = [
    'mcp_shell_tasks_run_shell_command',
    'mcp_shell_tasks_tmux_run',
    'mcp_shell_tasks_tmux_capture_output',
    'mcp_project_files_*',
    'mcp_code_writer_*',
    'mcp_shell_tasks_list_workspace_files',
  ];

  const troubleshootingIssues = [
    {
      issue: t('docs.troubleshooting.permissionErrors'),
      solution: 'Fix ~/.deepseek_cli ownership: sudo chown -R $USER:$USER ~/.deepseek_cli'
    },
    {
      issue: t('docs.troubleshooting.missingTools'),
      solution: 'Main agent intentionally disallows shell; use sub-agents for shell operations'
    },
    {
      issue: t('docs.troubleshooting.mcpTimeout'),
      solution: 'Default 5min, override with MODEL_CLI_MCP_TIMEOUT_MS environment variable'
    },
    {
      issue: t('docs.troubleshooting.longCommands'),
      solution: 'Use tmux tools: tmux_run for long-running commands'
    },
    {
      issue: t('docs.troubleshooting.historyTooLong'),
      solution: 'Rely on auto-prune or use /reset command to clear session'
    },
  ];

  const envVars = [
    { var: 'DEEPSEEK_API_KEY', description: 'API key for models' },
    { var: 'MODEL_CLI_LOG_REQUEST=1', description: 'Enable request logging' },
    { var: 'MODEL_CLI_RETRY=<n>', description: 'Number of retries' },
    { var: 'MODEL_CLI_MCP_TIMEOUT_MS', description: 'MCP timeout (default 300000)' },
    { var: 'MODEL_CLI_SUMMARY_TOKENS', description: 'Summary threshold (default 60000)' },
    { var: 'MODEL_CLI_SESSION_ROOT', description: 'Custom session root directory' },
  ];

  useEffect(() => {
    const handleScroll = () => {
      const sections = sidebarItems.map(item => document.getElementById(item.id));
      const scrollPosition = window.scrollY + 100;

      for (let i = sections.length - 1; i >= 0; i--) {
        if (sections[i] && scrollPosition >= sections[i].offsetTop) {
          setActiveSection(sidebarItems[i].id);
          break;
        }
      }
    };

    window.addEventListener('scroll', handleScroll);
    return () => window.removeEventListener('scroll', handleScroll);
  }, []);

  const scrollToSection = (id) => {
    const element = document.getElementById(id);
    if (element) {
      element.scrollIntoView({ behavior: 'smooth', block: 'start' });
      setActiveSection(id);
    }
  };

  return (
    <div className="min-h-screen bg-gradient-to-b from-dark-950 via-dark-900 to-dark-950">
      <SEO 
        title={t('docs.seo.title')}
        description={t('docs.seo.description')}
        keywords={t('docs.seo.keywords')}
      />
      
      <div className="container mx-auto px-4 py-12">
        {/* Header */}
        <div className="mb-12">
          <div className="flex items-center mb-4">
            <BookOpen className="w-10 h-10 text-primary-400 mr-4" />
            <div>
              <h1 className="text-4xl md:text-5xl font-bold text-white">{t('docs.title')}</h1>
              <p className="text-xl text-dark-300 mt-2">
                {t('docs.description')}
              </p>
            </div>
          </div>
        </div>

        <div className="grid grid-cols-1 lg:grid-cols-4 gap-8">
          {/* Sidebar Navigation */}
          <div className="lg:col-span-1">
            <nav className="sticky top-24 card p-6">
              <h3 className="font-bold text-white mb-4 text-lg flex items-center gap-2">
                <FileText className="w-5 h-5" />
                {t('docs.sidebar.title')}
              </h3>
              <ul className="space-y-2">
                {sidebarItems.map((item) => (
                  <li key={item.id}>
                    <button
                      onClick={() => scrollToSection(item.id)}
                      className={`w-full flex items-center text-left p-3 rounded-lg transition-colors ${
                        activeSection === item.id
                          ? 'bg-primary-900/30 text-primary-300 border border-primary-800/50'
                          : 'text-dark-300 hover:text-white hover:bg-dark-800'
                      }`}
                    >
                      <span className="mr-3">{item.icon}</span>
                      {item.label}
                      <ChevronRight className={`w-4 h-4 ml-auto transition-transform ${
                        activeSection === item.id ? 'rotate-90' : ''
                      }`} />
                    </button>
                  </li>
                ))}
              </ul>
              
              <div className="mt-8 pt-6 border-t border-dark-800">
                <a
                  href="https://github.com/leeoohoo/deepseek-cli"
                  target="_blank"
                  rel="noopener noreferrer"
                  className="btn-secondary w-full flex items-center justify-center gap-2"
                >
                  <ExternalLink className="w-4 h-4" />
                  {t('docs.sidebar.githubButton')}
                </a>
              </div>
            </nav>
          </div>

          {/* Main Content */}
          <div className="lg:col-span-3 space-y-12">
            {/* Getting Started */}
            <section id="getting-started" className="card p-8">
              <div className="flex items-center mb-6">
                <BookOpen className="w-8 h-8 text-primary-400 mr-3" />
                <h2 className="text-2xl font-bold text-white">{t('docs.sections.gettingStarted.title')}</h2>
              </div>
              <div className="space-y-4 text-dark-300">
                <p>
                  {t('docs.sections.gettingStarted.p1')}
                </p>
                <p>
                  {t('docs.sections.gettingStarted.p2')}
                </p>
                <p>
                  {t('docs.sections.gettingStarted.p3')}
                </p>
              </div>
            </section>

            {/* UI Interface */}
            <section id="ui-interface" className="card p-8">
              <div className="flex items-center mb-6">
                <Monitor className="w-8 h-8 text-primary-400 mr-3" />
                <h2 className="text-2xl font-bold text-white">{t('docs.sections.uiInterface.title')}</h2>
              </div>
              <p className="text-dark-300">
                {t('docs.sections.uiInterface.description')}
              </p>
            </section>
            {/* Installation */}
            <section id="installation" className="card p-8">
              <div className="flex items-center mb-6">
                <Download className="w-8 h-8 text-primary-400 mr-3" />
                <h2 className="text-2xl font-bold text-white">{t('docs.sections.installation.title')}</h2>
              </div>
              <p className="text-dark-300 mb-8">
                {t('docs.sections.installation.description')}
              </p>

              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                {installationCommands.map((item, index) => (
                  <motion.div
                    key={item.title}
                    initial={{ opacity: 0, y: 20 }}
                    animate={{ opacity: 1, y: 0 }}
                    transition={{ duration: 0.3, delay: index * 0.1 }}
                    className="bg-dark-800/50 border border-dark-700 rounded-xl p-6"
                  >
                    <h3 className="font-bold text-white mb-3">{item.title}</h3>
                    <div className="relative group mb-3">
                      <div className="code-block">
                        <pre className="text-green-400 whitespace-pre-wrap">{item.command}</pre>
                      </div>
                      <button
                        onClick={() => copyToClipboard(item.command, `install-${index}`)}
                        className="absolute top-3 right-3 p-2 bg-dark-900 rounded-lg opacity-0 group-hover:opacity-100 transition-opacity"
                      >
                        {copiedCommands[`install-${index}`] ? (
                          <Check className="w-4 h-4 text-green-400" />
                        ) : (
                          <Copy className="w-4 h-4 text-dark-400" />
                        )}
                      </button>
                    </div>
                    <p className="text-dark-400 text-sm">{item.description}</p>
                  </motion.div>
                ))}
              </div>
            </section>

            {/* Configuration */}
            <section id="configuration" className="card p-8">
              <div className="flex items-center mb-6">
                <Settings className="w-8 h-8 text-primary-400 mr-3" />
                <h2 className="text-2xl font-bold text-white">{t('docs.sections.configuration.title')}</h2>
              </div>
              <p className="text-dark-300 mb-6">
                {t('docs.sections.configuration.description')}
              </p>
              
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
                {configPaths.map((config, index) => (
                  <div key={index} className="flex items-start gap-3 p-4 bg-dark-800/30 rounded-lg border border-dark-700">
                    <Folder className="w-5 h-5 text-primary-400 mt-0.5" />
                    <div>
                      <code className="text-white text-sm">{config.path}</code>
                      <p className="text-dark-400 text-sm mt-1">{config.description}</p>
                    </div>
                  </div>
                ))}
              </div>

              <div className="bg-dark-900 rounded-xl p-6">
                <pre className="text-dark-300 text-sm overflow-x-auto">
                  <code>{`# Example system-prompt.yaml
system_prompt: |
  You are DeepSeek CLI, an AI terminal assistant.
  You have access to sub-agents via invoke_sub_agent.
  Always use task management tools to track progress.

# Example models.yaml
models:
  - id: deepseek-chat
    name: DeepSeek Chat
    provider: deepseek
    api_key_env: DEEPSEEK_API_KEY`}</code>
                </pre>
              </div>
            </section>

            {/* Commands Reference */}
            <section id="commands-reference" className="card p-8">
              <div className="flex items-center mb-6">
                <Command className="w-8 h-8 text-primary-400 mr-3" />
                <h2 className="text-2xl font-bold text-white">{t('docs.sections.commandsReference.title')}</h2>
              </div>
              <p className="text-dark-300 mb-6">
                {t('docs.sections.commandsReference.description')}
              </p>
              
              <div className="overflow-x-auto">
                <table className="w-full">
                  <thead>
                    <tr className="bg-dark-800/50">
                      <th className="py-3 px-4 text-left text-dark-300 font-semibold">{t('docs.table.command')}</th>
                      <th className="py-3 px-4 text-left text-dark-300 font-semibold">{t('docs.table.description')}</th>
                      <th className="py-3 px-4 text-left text-dark-300 font-semibold">{t('docs.table.copy')}</th>
                    </tr>
                  </thead>
                  <tbody>
                    {chatCommands.map((cmd, index) => (
                      <tr key={index} className="border-b border-dark-800/50 last:border-0">
                        <td className="py-4 px-4">
                          <code className="font-mono text-primary-300">{cmd.command}</code>
                        </td>
                        <td className="py-4 px-4 text-dark-300">{cmd.description}</td>
                        <td className="py-4 px-4">
                          <button
                            onClick={() => copyToClipboard(cmd.command, `cmd-${index}`)}
                            className="p-2 bg-dark-800 rounded-lg hover:bg-dark-700 transition-colors"
                          >
                            {copiedCommands[`cmd-${index}`] ? (
                              <Check className="w-4 h-4 text-green-400" />
                            ) : (
                              <Copy className="w-4 h-4 text-dark-400" />
                            )}
                          </button>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </section>

            {/* Sub-Agent System */}
            <section id="sub-agent-system" className="card p-8">
              <div className="flex items-center mb-6">
                <Users className="w-8 h-8 text-primary-400 mr-3" />
                <h2 className="text-2xl font-bold text-white">{t('docs.sections.subAgentSystem.title')}</h2>
              </div>
              
              <div className="space-y-6">
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <div className="bg-dark-800/30 p-6 rounded-xl border border-dark-700">
                    <h3 className="font-bold text-white mb-3 flex items-center gap-2">
                      <Code className="w-5 h-5 text-primary-400" />
                      Main Agent
                    </h3>
                    <p className="text-dark-300">
                      Orchestrator only, uses <code className="text-primary-300">invoke_sub_agent</code>, task manager tools, no shell access.
                    </p>
                  </div>
                  
                  <div className="bg-dark-800/30 p-6 rounded-xl border border-dark-700">
                    <h3 className="font-bold text-white mb-3 flex items-center gap-2">
                      <Cpu className="w-5 h-5 text-purple-400" />
                      Sub-Agents
                    </h3>
                    <p className="text-dark-300">
                      Full MCP tool access (filesystem, shell, tmux, tasks) for specialized operations.
                    </p>
                  </div>
                </div>

                <div className="bg-dark-900 rounded-xl p-6">
                  <h4 className="font-bold text-white mb-4">Plugin Structure</h4>
                  <pre className="text-dark-300 text-sm overflow-x-auto">
                    <code>{`subagents/plugins/
├── plugin.json          # Plugin metadata
├── agents/
│   └── *.md            # Agent definitions
└── skills/
    └── *.md            # Skill definitions`}</code>
                  </pre>
                </div>

                <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                  {[
                    { icon: <Code className="w-6 h-6" />, label: 'Python' },
                    { icon: <GitBranch className="w-6 h-6" />, label: 'React' },
                    { icon: <Cpu className="w-6 h-6" />, label: 'Spring Boot' },
                    { icon: <Cloud className="w-6 h-6" />, label: 'DevOps' },
                    { icon: <Database className="w-6 h-6" />, label: 'Database' },
                    { icon: <Shield className="w-6 h-6" />, label: 'Security' },
                    { icon: <Zap className="w-6 h-6" />, label: 'CI/CD' },
                    { icon: <Wrench className="w-6 h-6" />, label: 'Tools' },
                  ].map((item, index) => (
                    <div key={index} className="flex flex-col items-center p-4 bg-dark-800/30 rounded-lg">
                      <div className="text-primary-400 mb-2">{item.icon}</div>
                      <span className="text-dark-300 text-sm">{item.label}</span>
                    </div>
                  ))}
                </div>
              </div>
            </section>

            {/* MCP Tools */}
            <section id="mcp-tools" className="card p-8">
              <div className="flex items-center mb-6">
                <Wrench className="w-8 h-8 text-primary-400 mr-3" />
                <h2 className="text-2xl font-bold text-white">{t('docs.sections.mcpTools.title')}</h2>
              </div>
              
              <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div>
                  <h3 className="font-bold text-white mb-4 flex items-center gap-2">
                    <Terminal className="w-5 h-5" />
                    Main Agent Tools
                  </h3>
                  <div className="space-y-2">
                    {mcpToolsMain.map((tool, index) => (
                      <div key={index} className="flex items-center gap-3 p-3 bg-dark-800/30 rounded-lg">
                        <div className="w-2 h-2 rounded-full bg-primary-500" />
                        <code className="text-dark-300">{tool}</code>
                      </div>
                    ))}
                  </div>
                </div>
                
                <div>
                  <h3 className="font-bold text-white mb-4 flex items-center gap-2">
                    <Terminal className="w-5 h-5" />
                    Sub-Agent Tools
                  </h3>
                  <div className="space-y-2">
                    {mcpToolsSub.map((tool, index) => (
                      <div key={index} className="flex items-center gap-3 p-3 bg-dark-800/30 rounded-lg">
                        <div className="w-2 h-2 rounded-full bg-purple-500" />
                        <code className="text-dark-300">{tool}</code>
                      </div>
                    ))}
                  </div>
                </div>
              </div>
            </section>

            {/* Task Management */}
            <section id="task-management" className="card p-8">
              <div className="flex items-center mb-6">
                <ListChecks className="w-8 h-8 text-primary-400 mr-3" />
                <h2 className="text-2xl font-bold text-white">{t('docs.sections.taskManagement.title')}</h2>
              </div>
              
              <div className="space-y-6">
                <div className="bg-dark-900 rounded-xl p-6">
                  <pre className="text-dark-300 text-sm overflow-x-auto">
                    <code>{`// Task management workflow
1. invoke_sub_agent injects task rules into sub-agent prompts
2. Sub-agents must use mcp_task_manager_add_task to record tasks
3. Use update_task for progress tracking
4. Use complete_task with completion notes when done

// Example
mcp_task_manager_add_task({
  title: "[Execution] 1. Refactor authentication module",
  details: "Refactor src/auth.js to use JWT with proper error handling",
  priority: "high",
  tags: ["refactor", "auth"]
});`}</code>
                  </pre>
                </div>
                
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                  <div className="p-4 bg-dark-800/30 rounded-lg border border-dark-700">
                    <h4 className="font-bold text-white mb-2">{t('docs.taskManagement.addTask')}</h4>
                    <p className="text-dark-400 text-sm">{t('docs.taskManagement.addTaskDescription')}</p>
                  </div>
                  <div className="p-4 bg-dark-800/30 rounded-lg border border-dark-700">
                    <h4 className="font-bold text-white mb-2">{t('docs.taskManagement.updateProgress')}</h4>
                    <p className="text-dark-400 text-sm">{t('docs.taskManagement.updateProgressDescription')}</p>
                  </div>
                  <div className="p-4 bg-dark-800/30 rounded-lg border border-dark-700">
                    <h4 className="font-bold text-white mb-2">{t('docs.taskManagement.complete')}</h4>
                    <p className="text-dark-400 text-sm">{t('docs.taskManagement.completeDescription')}</p>
                  </div>
                </div>
              </div>
            </section>

            {/* Troubleshooting */}
            <section id="troubleshooting" className="card p-8">
              <div className="flex items-center mb-6">
                <HelpCircle className="w-8 h-8 text-primary-400 mr-3" />
                <h2 className="text-2xl font-bold text-white">{t('docs.sections.troubleshooting.title')}</h2>
              </div>
              
              <div className="space-y-4">
                {troubleshootingIssues.map((item, index) => (
                  <div key={index} className="p-4 bg-dark-800/30 rounded-lg border border-dark-700">
                    <h4 className="font-bold text-white mb-2">{item.issue}</h4>
                    <div className="code-block mt-2">
                      <code className="text-green-400">{item.solution}</code>
                    </div>
                  </div>
                ))}
              </div>
            </section>

            {/* Environment Variables */}
            <section id="environment-variables" className="card p-8">
              <div className="flex items-center mb-6">
                <FileText className="w-8 h-8 text-primary-400 mr-3" />
                <h2 className="text-2xl font-bold text-white">{t('docs.sections.environmentVariables.title')}</h2>
              </div>
              
              <div className="overflow-x-auto">
                <table className="w-full">
                  <thead>
                    <tr className="bg-dark-800/50">
                      <th className="py-3 px-4 text-left text-dark-300 font-semibold">Variable</th>
                      <th className="py-3 px-4 text-left text-dark-300 font-semibold">Description</th>
                      <th className="py-3 px-4 text-left text-dark-300 font-semibold">Copy</th>
                    </tr>
                  </thead>
                  <tbody>
                    {envVars.map((env, index) => (
                      <tr key={index} className="border-b border-dark-800/50 last:border-0">
                        <td className="py-4 px-4">
                          <code className="font-mono text-primary-300">{env.var}</code>
                        </td>
                        <td className="py-4 px-4 text-dark-300">{env.description}</td>
                        <td className="py-4 px-4">
                          <button
                            onClick={() => copyToClipboard(env.var, `env-${index}`)}
                            className="p-2 bg-dark-800 rounded-lg hover:bg-dark-700 transition-colors"
                          >
                            {copiedCommands[`env-${index}`] ? (
                              <Check className="w-4 h-4 text-green-400" />
                            ) : (
                              <Copy className="w-4 h-4 text-dark-400" />
                            )}
                          </button>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </section>
          </div>
        </div>
      </div>
    </div>
  );
};

export default Docs;